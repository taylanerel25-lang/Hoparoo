<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rainbow Flight - For the Triplet Superstars! üåà‚ú®</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: linear-gradient(to bottom, #87CEEB, #E0FFFF);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: 'Arial', sans-serif;
        }
        canvas {
            display: block;
            border: 1px solid #000;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        #game-over, #char-select, #shop, #my-stuff, #my-house {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: none;
            width: 90%;
            max-width: 300px;
            overflow-y: auto;
            max-height: 90vh;
        }
        #char-select {
            flex-direction: column;
            gap: 15px;
            background: linear-gradient(135deg, #FFD700, #FF69B4, #87CEFA);
            border: 4px solid #FFD700;
        }
        #char-select h2 {
            margin: 0 0 15px 0;
            font-size: 24px;
            color: #333;
            text-shadow: 2px 2px 4px rgba(255,255,255,0.8);
        }
        .char-btn {
            background: rgba(255,255,255,0.9);
            border: 3px solid #FFD700;
            border-radius: 15px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .char-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(255,215,0,0.6);
            background: rgba(255,255,255,1);
        }
        .char-preview {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #FFD700;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .char-placeholder {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid #FFD700;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        #game-over {
            font-size: 36px;
            color: red;
        }
        #restart-btn {
            font-size: 20px;
            padding: 8px 16px;
            background: #FFD700;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 10px;
            font-weight: bold;
        }
        #restart-btn:hover { background: #FFA500; }
        #score {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 24px;
            color: #333;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(255,255,255,0.8);
            user-select: none;
        }
        #coins {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            color: #333;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(255,255,255,0.8);
            user-select: none;
            display: flex;
            align-items: center;
        }
        #jewellery {
            position: absolute;
            top: 40px;
            right: 10px;
            font-size: 24px;
            color: #333;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(255,255,255,0.8);
            user-select: none;
            display: flex;
            align-items: center;
        }
        #shop, #my-stuff, #my-house {
            flex-direction: column;
            gap: 10px;
            background: linear-gradient(135deg, #FF69B4, #87CEFA, #FFD700);
            border: 4px solid #FF69B4;
        }
        #shop h2, #my-stuff h2, #my-house h2 {
            font-size: 28px;
            color: #FF1493;
            text-shadow: 2px 2px 4px rgba(255,255,255,0.8);
        }
        #shop h3, #my-stuff h3 {
            font-size: 24px;
            margin: 5px 0;
            color: #4B0082;
        }
        #shop button, #my-stuff button, #my-house button {
            background: #FFD700;
            border: none;
            border-radius: 10px;
            padding: 8px 16px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
        }
        #shop button:hover, #my-stuff button:hover, #my-house button:hover {
            background: #FFA500;
        }
        #shop .close-btn, #my-stuff .close-btn, #my-house .close-btn {
            background: #FF69B4; /* Pink color for close button */
        }
        #back-home {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 28px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #FF69B4, #FFD700);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            color: #333;
            font-weight: bold;
            display: none;
        }
        #back-home:hover {
            transform: translateX(-50%) scale(1.05);
        }
        #dedication {
            font-size: 20px;
            color: #333;
            text-shadow: 2px 2px 4px rgba(255,255,255,0.8);
            margin-bottom: 15px;
        }
        #dedication emoji {
            font-size: 2em;
        }
        @media (max-width: 400px) {
            #char-select h2, #shop h2, #my-stuff h2, #my-house h2 {
                font-size: 20px;
            }
            .char-btn {
                font-size: 14px;
                padding: 8px;
                gap: 8px;
            }
            .char-preview, .char-placeholder {
                width: 50px;
                height: 50px;
            }
            #shop h3, #my-stuff h3 {
                font-size: 18px;
            }
            #shop button, #my-stuff button, #my-house button {
                font-size: 14px;
                padding: 6px 12px;
            }
            #dedication {
                font-size: 16px;
            }
            #score, #coins, #jewellery {
                font-size: 20px;
            }
            #coin-display-img, #jewellery-display-img {
                width: 30px;
                height: 30px;
            }
        }
        @media (orientation: landscape) {
            #char-select {
                gap: 10px;
                padding: 15px;
            }
            .char-btn {
                padding: 8px;
                font-size: 16px;
            }
            #char-select h2 {
                font-size: 22px;
            }
        }
    </style>
</head>
<body>
<div id="score">Score: 0</div>
<div id="coins"><img id="coin-display-img" src="" style="width: 40px; height: 40px; margin-right: 10px;"><span id="coin-count">0</span></div>
<div id="jewellery"><img id="jewellery-display-img" src="" style="width: 40px; height: 40px; margin-right: 10px;"><span id="jewellery-count">0</span></div>
    <canvas id="gameCanvas"></canvas>
    <div id="char-select">
        <div id="dedication">A game for you! made by your uncle Tay Tay <span style="font-size: 2em;">üëÆ‚Äç‚ôÇÔ∏è</span></div>
        <h2>üåà Choose Your Superstar! ‚ú®</h2>
        <button class="char-btn" onclick="selectCharacter(0)">
            <img class="char-preview" src="Alayna.png" alt="Alayna" onerror="this.style.display='none'; this.nextSibling.style.display='block';">
            <div class="char-placeholder" style="background-color: #dda0dd; display: none;"></div>
            <span>üöÄ Alayna! üíú</span>
        </button>
        <button class="char-btn" onclick="selectCharacter(1)">
            <img class="char-preview" src="Jazmine.png" alt="Jazmine" onerror="this.style.display='none'; this.nextSibling.style.display='block';">
            <div class="char-placeholder" style="background-color: #ffc0cb; display: none;"></div>
            <span>üåü Jazmine! üíï</span>
        </button>
        <button class="char-btn" onclick="selectCharacter(2)">
            <img class="char-preview" src="Lilah.png" alt="Lilah" onerror="this.style.display='none'; this.nextSibling.style.display='block';">
            <div class="char-placeholder" style="background-color: #87cefa; display: none;"></div>
            <span>‚≠ê Lilah! üíô</span>
        </button>
        <button class="char-btn" onclick="selectCharacter(3)">
            <img class="char-preview" src="Louisa.png" alt="Louisa" onerror="this.style.display='none'; this.nextSibling.style.display='block';">
            <div class="char-placeholder" style="background-color: #ffc0cb; display: none;"></div>
            <span>üöÄ Louisa! üíï</span>
        </button>
        <button class="char-btn" onclick="selectCharacter(4)">
            <img class="char-preview" src="Julia.png" alt="Julia" onerror="this.style.display='none'; this.nextSibling.style.display='block';">
            <div class="char-placeholder" style="background-color: #dda0dd; display: none;"></div>
            <span>üåü Julia! üíú</span>
        </button>
        <button class="char-btn" onclick="openShop()">
            <span>Shop üõçÔ∏è</span>
        </button>
        <button class="char-btn" onclick="openMyStuff()">
            <span>My Stuff üéí</span>
        </button>
        <button class="char-btn" onclick="openMyHouse()">
            <span>My House üè†</span>
        </button>
    </div>
    <div id="shop">
        <h2>Kid-Friendly Shop! üõçÔ∏è</h2>
        <p>Your Coins: <span id="shop-coins">0</span> üí∞</p>
        <div>
            <h3>Fluffy Kitten</h3>
            <img id="kitten-preview" src="ChatGPT Image Nov 2, 2025, 01_40_49 PM.png" alt="Fluffy Kitten" style="width: 100px; height: 100px; border-radius: 10px;">
            <p id="kitten-cost"><img id="coin-icon" src="" style="width: 20px; height: 20px;"> 50</p>
            <button onclick="buyKitten()">Buy! üòª</button>
        </div>
        <div>
            <h3>Cute Puppy</h3>
            <img id="puppy-preview" src="ChatGPT Image Nov 2, 2025, 02_17_17 PM.png" alt="Cute Puppy" style="width: 100px; height: 100px; border-radius: 10px;">
            <p id="puppy-cost"><img id="coin-icon2" src="" style="width: 20px; height: 20px;"> 50</p>
            <button onclick="buyPuppy()">Buy! üê∂</button>
        </div>
        <div>
            <h3>Princess Crown</h3>
            <img id="crown-preview" src="Crown.png" alt="Princess Crown" style="width: 100px; height: 100px; border-radius: 10px;">
            <p id="crown-cost"><img id="coin-icon3" src="" style="width: 20px; height: 20px;"> 50</p>
            <button onclick="buyCrown()">Buy! üëë</button>
        </div>
        <button class="close-btn" onclick="closeShop()">Close</button>
    </div>
    <div id="my-stuff">
        <h2>My Stuff! üéí</h2>
        <div id="inventory-list"></div>
        <button class="close-btn" onclick="closeMyStuff()">Close</button>
    </div>
    <div id="my-house">
        <h2>My House! üè†</h2>
        <p>Welcome to your empty house! Collect items to decorate it.</p>
        <button class="close-btn" onclick="closeMyHouse()">Close</button>
    </div>
    <div id="game-over">
        Oh no! Splash! üí¶<br>
        Final Score: <span id="final-score">0</span><br>
        <button id="restart-btn" onclick="restartGame()">Play Again! üöÄ</button>
    </div>
    <button id="back-home" onclick="restartGame()">Back Home üè†</button>
    <!-- Audio elements - Add your fun files here! -->
    <audio id="bgMusic" loop preload="auto"></audio>
    <audio id="flapSound">
        <source src="flap-sound.mp3" type="audio/mpeg"> <!-- Wing flap whoosh! -->
    </audio>
    <audio id="coinSound" preload="auto">
        <source src="retro-coin-3-236679.mp3" type="audio/mpeg">
    </audio>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        // Audio hooks
        const bgMusic = document.getElementById('bgMusic');
        const flapSound = document.getElementById('flapSound');
        const coinSound = document.getElementById('coinSound');
        const characterMusic = [
            'HUNTRIX - What It Sounds Like (Lyrics) KPop Demon Hunters.mp3',
            'html headtitle410 Gonetitlehead body centerh1410 Goneh1center hrcenternginx1.24.0 (Ubuntu)center body html.mp3',
            'HUNTRIX - What It Sounds Like (Lyrics) KPop Demon Hunters.mp3',
            'HUNTRIX - What It Sounds Like (Lyrics) KPop Demon Hunters.mp3',
            'html headtitle410 Gonetitlehead body centerh1410 Goneh1center hrcenternginx1.24.0 (Ubuntu)center body html.mp3'
        ];
        // Core tuning (tweaked for easier play)
        const gravity = 0.5; // A bit heavier for satisfying jumps
        const jumpStrength = -15; // Even bigger leap for easier dodging!
        const gameSpeed = 2; // Slower scroll for chill racing vibe
        const waterHeightRatio = 0.25;
        const waveAmplitude = 26;
        const waveFrequency = 0.015;
        const beatSpeed = 0.008;
        // Runtime state
        let waterHeight = canvas.height * waterHeightRatio;
        let waveOffset = 0;
        let beatPhase = 0;
        let score = 0;
        let coins = localStorage.getItem('coins') ? parseInt(localStorage.getItem('coins')) : 0;
        let jewellery = localStorage.getItem('jewellery') ? parseInt(localStorage.getItem('jewellery')) : 0;
        let inventory = localStorage.getItem('inventory') ? JSON.parse(localStorage.getItem('inventory')) : [];
        let equippedPet = localStorage.getItem('equippedPet') || null;
        let equippedAccessory = localStorage.getItem('equippedAccessory') || null;
        let gameOver = false;
        let selectedIndex = -1;
        let animationId = null;
        let musicUnlockHandler = null;
        let obstacleColor = '#000000'; // Default, set per character
        const characters = [
            { name: 'Alayna', x: 0, y: 0, vy: 0, image: new Image(), ready: false, placeholder: '#dda0dd' },
            { name: 'Jazmine', x: 0, y: 0, vy: 0, image: new Image(), ready: false, placeholder: '#ffc0cb' },
            { name: 'Lilah', x: 0, y: 0, vy: 0, image: new Image(), ready: false, placeholder: '#87cefa' },
            { name: 'Louisa', x: 0, y: 0, vy: 0, image: new Image(), ready: false, placeholder: '#ffc0cb' },
            { name: 'Julia', x: 0, y: 0, vy: 0, image: new Image(), ready: false, placeholder: '#dda0dd' }
        ];
        characters[0].image.src = 'Alayna.png';
        characters[1].image.src = 'Jazmine.png';
        characters[2].image.src = 'Lilah.png';
        characters[3].image.src = 'Louisa.png';
        characters[4].image.src = 'Julia.png';
        const charSize = 60; // Back to original for single char focus
        const wingSize = 25;
        let jumpingPressed = false;
        let jumpingPressedPrev = false;
        let obstacles = [];
        let coinsList = [];
        let jewelleryList = [];
        let obstacleSpawnTimer = 0;
        let coinSpawnTimer = 0;
        let jewellerySpawnTimer = 0;
        const obstacleInterval = 150; // More frequent for excitement
        const coinInterval = 200; // Coins a bit less frequent
        const jewelleryInterval = coinInterval * 5; // Rare: ~1 every 5 coins
        const obstacleSize = 75; // Big hearts!
        const coinSize = 40; // Golden coins
        const jewellerySize = 40; // Jewellery size
        const petSize = 50; // Size for equipped pet
        const crownSize = 30; // Small size for crown to fit on head
        let jewelleryImage = new Image();
        jewelleryImage.src = 'ChatGPT Image Nov 2, 2025, 01_11_08 PM.png';
        let jewelleryReady = false;
        let jewellerySrc = '';
        let coinImage = new Image();
        coinImage.src = 'ChatGPT Image Nov 2, 2025, 01_25_25 PM.png';
        let coinReady = false;
        let coinSrc = '';
        let kittenImage = new Image();
        kittenImage.src = 'ChatGPT Image Nov 2, 2025, 01_40_49 PM.png';
        let kittenReady = false;
        let kittenSrc = '';
        let puppyImage = new Image();
        puppyImage.src = 'ChatGPT Image Nov 2, 2025, 02_17_17 PM.png';
        let puppyReady = false;
        let puppySrc = '';
        let crownImage = new Image();
        crownImage.src = 'Crown.png';
        let crownReady = false;
        let crownSrc = '';
        function processImage(img, index, callback, autoRemoveBg = false) {
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = img.width;
            tempCanvas.height = img.height;
            tempCtx.drawImage(img, 0, 0);
            let imageData = tempCtx.getImageData(0, 0, img.width, img.height);
            let data = imageData.data;
            let bgR = 0, bgG = 0, bgB = 0;
            if (autoRemoveBg) {
                bgR = data[0];
                bgG = data[1];
                bgB = data[2];
            }
            // Remove background
            for (let i = 0; i < data.length; i += 4) {
                if (autoRemoveBg) {
                    if (Math.abs(data[i] - bgR) < 30 && Math.abs(data[i + 1] - bgG) < 30 && Math.abs(data[i + 2] - bgB) < 30) {
                        data[i + 3] = 0; // Make transparent
                    }
                } else {
                    if (data[i] < 5 && data[i + 1] < 5 && data[i + 2] < 5) {
                        data[i + 3] = 0; // Make transparent for black bg
                    }
                }
            }
            tempCtx.putImageData(imageData, 0, 0);
            // Find bounding box of non-transparent pixels
            let minX = img.width, minY = img.height, maxX = 0, maxY = 0;
            for (let i = 0; i < data.length; i += 4) {
                if (data[i + 3] > 0) {
                    const x = (i / 4) % img.width;
                    const y = Math.floor((i / 4) / img.width);
                    minX = Math.min(minX, x);
                    maxX = Math.max(maxX, x);
                    minY = Math.min(minY, y);
                    maxY = Math.max(maxY, y);
                }
            }
            if (minX > maxX || minY > maxY) {
                // No non-transparent pixels? Fallback to original
                return callback(img);
            }
            const cropWidth = maxX - minX + 1;
            const cropHeight = maxY - minY + 1;
            // Make square by padding with transparent space to preserve aspect ratio
            const side = Math.max(cropWidth, cropHeight);
            const newCanvas = document.createElement('canvas');
            newCanvas.width = side;
            newCanvas.height = side;
            const newCtx = newCanvas.getContext('2d');
            const offsetX = (side - cropWidth) / 2;
            const offsetY = (side - cropHeight) / 2;
            newCtx.drawImage(tempCanvas, minX, minY, cropWidth, cropHeight, offsetX, offsetY, cropWidth, cropHeight);
            // Create new image from processed canvas
            const newImg = new Image();
            newImg.src = newCanvas.toDataURL('image/png');
            newImg.onload = () => {
                callback(newImg);
                // Update the preview img src too if index valid
                if (index >= 0) {
                    const previews = document.querySelectorAll('.char-btn img.char-preview');
                    if (previews[index]) {
                        previews[index].src = newImg.src;
                    }
                }
            };
        }
        function detachMusicUnlock() {
            if (!musicUnlockHandler) return;
            window.removeEventListener('pointerdown', musicUnlockHandler);
            window.removeEventListener('touchstart', musicUnlockHandler);
            musicUnlockHandler = null;
        }
        function attachMusicUnlock() {
            if (musicUnlockHandler) return;
            musicUnlockHandler = () => {
                bgMusic.play().catch(() => {});
                detachMusicUnlock();
            };
            window.addEventListener('pointerdown', musicUnlockHandler);
            window.addEventListener('touchstart', musicUnlockHandler);
        }
        function setCharacterMusic(index) {
            const musicSrc = characterMusic[index];
            if (!musicSrc) return;
            if (bgMusic.getAttribute('data-current-src') !== musicSrc) {
                bgMusic.pause();
                bgMusic.src = musicSrc;
                bgMusic.load();
                bgMusic.setAttribute('data-current-src', musicSrc);
            }
            bgMusic.currentTime = 0;
        }
        function tryStartMusic() {
            if (!bgMusic.src) return;
            const playPromise = bgMusic.play();
            if (playPromise && typeof playPromise.then === 'function') {
                playPromise
                    .then(() => {
                        detachMusicUnlock();
                    })
                    .catch(() => {
                        attachMusicUnlock();
                    });
            } else {
                detachMusicUnlock();
            }
        }
        function selectCharacter(index) {
            selectedIndex = index;
            setCharacterMusic(index);
            tryStartMusic();
            document.getElementById('char-select').style.display = 'none';
            document.getElementById('back-home').style.display = 'block';
            initGame();
        }
        function showCharSelect() {
            document.getElementById('char-select').style.display = 'flex';
            document.getElementById('game-over').style.display = 'none';
            document.getElementById('back-home').style.display = 'none';
            bgMusic.pause();
            bgMusic.currentTime = 0;
            detachMusicUnlock();
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
        }
        window.addEventListener('mousedown', () => {
            jumpingPressed = true;
            tryStartMusic();
        });
        window.addEventListener('mouseup', () => (jumpingPressed = false));
        window.addEventListener('touchstart', (event) => {
            event.preventDefault();
            jumpingPressed = true;
            tryStartMusic();
        });
        window.addEventListener('touchend', () => (jumpingPressed = false));
        function drawWings(x, y, flapAngle) {
            ctx.strokeStyle = '#FFD700';
            ctx.lineWidth = 4;
            ctx.lineCap = 'round';
            ctx.beginPath();
            ctx.moveTo(x - charSize / 2, y);
            ctx.quadraticCurveTo(x - charSize / 2 - wingSize * 1.2, y + flapAngle * 1.5, x - charSize / 2 - wingSize / 2, y + flapAngle);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x + charSize / 2, y);
            ctx.quadraticCurveTo(x + charSize / 2 + wingSize * 1.2, y + flapAngle * 1.5, x + charSize / 2 + wingSize / 2, y + flapAngle);
            ctx.stroke();
        }
        function getWaterHeightAtX(x) {
            return canvas.height - waterHeight + Math.sin((x * waveFrequency + waveOffset) * 2) * waveAmplitude;
        }
        function drawRainbowWater() {
            beatPhase += beatSpeed;
            waveOffset += gameSpeed * 0.032 + Math.sin(beatPhase) * 0.025;
            const gradient = ctx.createLinearGradient(0, canvas.height - waterHeight * 1.5, 0, canvas.height);
            gradient.addColorStop(0, 'rgba(255, 0, 0, 0.82)');
            gradient.addColorStop(0.14, 'rgba(255, 140, 0, 0.8)');
            gradient.addColorStop(0.28, 'rgba(255, 215, 0, 0.82)');
            gradient.addColorStop(0.42, 'rgba(0, 200, 0, 0.78)');
            gradient.addColorStop(0.56, 'rgba(30, 144, 255, 0.8)');
            gradient.addColorStop(0.7, 'rgba(106, 90, 205, 0.82)');
            gradient.addColorStop(1, 'rgba(186, 85, 211, 0.9)');
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.moveTo(0, getWaterHeightAtX(0));
            for (let x = 0; x <= canvas.width; x += 5) {
                ctx.lineTo(x, getWaterHeightAtX(x));
            }
            ctx.lineTo(canvas.width, canvas.height);
            ctx.lineTo(0, canvas.height);
            ctx.fill();
            ctx.fillStyle = 'rgba(255, 255, 255, 0.35)';
            for (let i = 0; i < 20; i++) {
                const wx = (i * 110 + waveOffset * 12) % canvas.width;
                ctx.beginPath();
                ctx.arc(wx, getWaterHeightAtX(wx) - 12, 3.2, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        function drawHeart(x, y, size, color) {
            ctx.save();
            ctx.shadowColor = '#FFD700';
            ctx.shadowBlur = 10;
            ctx.beginPath();
            ctx.moveTo(x, y + size / 4);
            ctx.quadraticCurveTo(x + size / 2, y - size / 4, x + size / 2, y + size / 4);
            ctx.quadraticCurveTo(x + size / 2, y + size / 2, x, y + size * 3 / 4);
            ctx.quadraticCurveTo(x - size / 2, y + size / 2, x - size / 2, y + size / 4);
            ctx.quadraticCurveTo(x - size / 2, y - size / 4, x, y + size / 4);
            ctx.fillStyle = color;
            ctx.fill();
            ctx.restore();
        }
        function drawCoinItem(x, y, size) {
            if (coinReady) {
                ctx.drawImage(coinImage, x, y, size, size);
            } else {
                // Fallback placeholder
                ctx.fillStyle = '#FFD700';
                ctx.beginPath();
                ctx.arc(x + size / 2, y + size / 2, size / 2, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        function drawJewellery(x, y, size) {
            if (jewelleryReady) {
                ctx.drawImage(jewelleryImage, x, y, size, size);
            } else {
                // Fallback placeholder
                ctx.fillStyle = '#FFD700';
                ctx.beginPath();
                ctx.arc(x + size / 2, y + size / 2, size / 2, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        function updateObstacles() {
            obstacleSpawnTimer++;
            if (obstacleSpawnTimer > obstacleInterval) {
                const minY = 150;
                const maxY = canvas.height - waterHeight - obstacleSize - 50;
                const obsY = minY + Math.random() * (maxY - minY);
                obstacles.push({
                    x: canvas.width + obstacleSize,
                    y: obsY,
                    width: obstacleSize,
                    height: obstacleSize
                });
                obstacleSpawnTimer = 0;
            }
            for (let i = obstacles.length - 1; i >= 0; i--) {
                obstacles[i].x -= gameSpeed;
                if (obstacles[i].x + obstacles[i].width < 0) {
                    obstacles.splice(i, 1);
                }
            }
        }
        function updateCoins() {
            coinSpawnTimer++;
            if (coinSpawnTimer > coinInterval) {
                const minY = 150;
                const maxY = canvas.height - waterHeight - coinSize - 50;
                const coinY = minY + Math.random() * (maxY - minY);
                coinsList.push({
                    x: canvas.width + coinSize,
                    y: coinY,
                    width: coinSize,
                    height: coinSize
                });
                coinSpawnTimer = 0;
            }
            for (let i = coinsList.length - 1; i >= 0; i--) {
                coinsList[i].x -= gameSpeed;
                if (coinsList[i].x + coinsList[i].width < 0) {
                    coinsList.splice(i, 1);
                }
            }
        }
        function updateJewellery() {
            jewellerySpawnTimer++;
            if (jewellerySpawnTimer > jewelleryInterval) {
                const minY = 150;
                const maxY = canvas.height - waterHeight - jewellerySize - 50;
                const jewelleryY = minY + Math.random() * (maxY - minY);
                jewelleryList.push({
                    x: canvas.width + jewellerySize,
                    y: jewelleryY,
                    width: jewellerySize,
                    height: jewellerySize
                });
                jewellerySpawnTimer = 0;
            }
            for (let i = jewelleryList.length - 1; i >= 0; i--) {
                jewelleryList[i].x -= gameSpeed;
                if (jewelleryList[i].x + jewelleryList[i].width < 0) {
                    jewelleryList.splice(i, 1);
                }
            }
        }
        function drawObstacles() {
            for (const obs of obstacles) {
                drawHeart(obs.x + obs.width / 2, obs.y + obs.height / 2, obs.width, obstacleColor);
            }
        }
        function drawCoins() {
            for (const coin of coinsList) {
                drawCoinItem(coin.x, coin.y, coin.width);
            }
        }
        function drawJewelleryItems() {
            for (const jewel of jewelleryList) {
                drawJewellery(jewel.x, jewel.y, jewel.width);
            }
        }
        function checkObstacleCollision() {
            // Removed game over trigger; now immortal!
            for (const obs of obstacles) {
                const char = characters[selectedIndex];
                if (
                    char.x + charSize / 2 > obs.x &&
                    char.x - charSize / 2 < obs.x + obs.width &&
                    char.y + charSize / 2 > obs.y &&
                    char.y - charSize / 2 < obs.y + obs.height
                ) {
                    // Optional: Could add a bounce or effect here, but keeping it simple
                }
            }
        }
        function checkCoinCollection() {
            for (let i = coinsList.length - 1; i >= 0; i--) {
                const coin = coinsList[i];
                const char = characters[selectedIndex];
                if (
                    char.x + charSize / 2 > coin.x &&
                    char.x - charSize / 2 < coin.x + coin.width &&
                    char.y + charSize / 2 > coin.y &&
                    char.y - charSize / 2 < coin.y + coin.height
                ) {
                    coins++;
                    localStorage.setItem('coins', coins);
                    document.getElementById('coin-count').textContent = coins;
                    coinSound.play().catch(() => {});
                    if (navigator.vibrate) {
                        navigator.vibrate(200);
                    }
                    coinsList.splice(i, 1);
                }
            }
        }
        function checkJewelleryCollection() {
            for (let i = jewelleryList.length - 1; i >= 0; i--) {
                const jewel = jewelleryList[i];
                const char = characters[selectedIndex];
                if (
                    char.x + charSize / 2 > jewel.x &&
                    char.x - charSize / 2 < jewel.x + jewel.width &&
                    char.y + charSize / 2 > jewel.y &&
                    char.y - charSize / 2 < jewel.y + jewel.height
                ) {
                    jewellery++;
                    localStorage.setItem('jewellery', jewellery);
                    document.getElementById('jewellery-count').textContent = jewellery;
                    coinSound.play().catch(() => {}); // Reuse coin sound for jewellery
                    if (navigator.vibrate) {
                        navigator.vibrate(200);
                    }
                    jewelleryList.splice(i, 1);
                }
            }
        }
        function updateCharacters() {
            const char = characters[selectedIndex];
            if (jumpingPressed && !jumpingPressedPrev) {
                flapSound.currentTime = 0;
                flapSound.play().catch(() => {});
                char.vy = jumpStrength;
            }
            char.vy += gravity;
            char.y += char.vy;
            const ceiling = charSize / 2 + 20;
            if (char.y < ceiling) {
                char.y = ceiling;
                if (char.vy < 0) char.vy = 0;
            }
            const airLower = canvas.height - waterHeight - charSize - 20;
            if (char.y > airLower) {
                char.y = airLower;
                if (char.vy > 0) char.vy = 0;
            }
            // Removed water collision game over; now bounces off
            if (char.y + charSize / 2 > getWaterHeightAtX(char.x)) {
                char.y = getWaterHeightAtX(char.x) - charSize / 2;
                char.vy = 0;
            }
            jumpingPressedPrev = jumpingPressed;
        }
        function drawCharacters() {
            const time = Date.now() * 0.01;
            const flapBase = jumpingPressed ? Math.sin(time * 16) * -14 : Math.sin(time * 8) * 8;
            const char = characters[selectedIndex];
            const personalFlap = flapBase + Math.sin(time * 5 + selectedIndex) * 3;
            drawWings(char.x, char.y, personalFlap);
            ctx.save();
            ctx.beginPath();
            ctx.arc(char.x, char.y, charSize / 2, 0, Math.PI * 2);
            if (!char.ready) {
                ctx.fillStyle = char.placeholder;
                ctx.fill();
            }
            ctx.clip();
            ctx.shadowColor = jumpingPressed ? '#FFD700' : '#FFF';
            ctx.shadowBlur = 16;
            if (char.ready && char.image.naturalWidth) {
                ctx.filter = 'brightness(1.2) contrast(1.3) saturate(1.5)';
                ctx.drawImage(char.image, char.x - charSize / 2, char.y - charSize / 2, charSize, charSize);
                ctx.filter = 'none';
            }
            ctx.restore();
            // Draw equipped accessory if any
            if (equippedAccessory === 'crown' && crownReady) {
                ctx.drawImage(crownImage, char.x - crownSize / 2, char.y - charSize / 2 - crownSize / 2 - 5, crownSize, crownSize); // Position on top of head
            }
            // Draw equipped pet if any
            if (equippedPet === 'kitten' && kittenReady) {
                ctx.drawImage(kittenImage, char.x + charSize / 2 + 10, char.y - petSize / 2, petSize, petSize);
            } else if (equippedPet === 'puppy' && puppyReady) {
                ctx.drawImage(puppyImage, char.x + charSize / 2 + 10, char.y - petSize / 2, petSize, petSize);
            }
        }
        function drawScore() {
            document.getElementById('score').textContent = `Score: ${Math.floor(score / 60)}`;
        }
        function triggerGameOver() {
            // Disabled entirely for immortality mode
        }
        function gameLoop() {
            if (gameOver || selectedIndex === -1) return;
            score++;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const skyGrad = ctx.createLinearGradient(0, 0, 0, canvas.height * 0.6);
            skyGrad.addColorStop(0, '#87CEEB');
            skyGrad.addColorStop(0.5, '#B0E0E6');
            skyGrad.addColorStop(1, '#E0FFFF');
            ctx.fillStyle = skyGrad;
            ctx.fillRect(0, 0, canvas.width, canvas.height * 0.6);
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            for (let i = 0; i < 5; i++) {
                const cx = (i * 320 + score * 0.35) % (canvas.width + 220) - 110;
                const cy = 90 + i * 80;
                ctx.beginPath();
                ctx.arc(cx, cy, 40, 0, Math.PI * 2);
                ctx.arc(cx + 35, cy, 50, 0, Math.PI * 2);
                ctx.arc(cx + 70, cy, 35, 0, Math.PI * 2);
                ctx.fill();
            }
            drawRainbowWater();
            updateObstacles();
            updateCoins();
            updateJewellery();
            drawObstacles();
            drawCoins();
            drawJewelleryItems();
            checkObstacleCollision();
            checkCoinCollection();
            checkJewelleryCollection();
            updateCharacters();
            drawCharacters();
            drawScore();
            if (!gameOver) {
                animationId = requestAnimationFrame(gameLoop);
            }
        }
        function resetCharacters() {
            const char = characters[selectedIndex];
            char.x = canvas.width / 2;
            char.y = canvas.height / 2 - 50;
            char.vy = 0;
        }
        function initGame() {
            obstacleColor = characters[selectedIndex].placeholder;
            resetCharacters();
            gameOver = false;
            score = 0;
            // Don't reset coins and jewellery, as they are persistent
            document.getElementById('coin-count').textContent = coins;
            document.getElementById('jewellery-count').textContent = jewellery;
            obstacleSpawnTimer = 0;
            coinSpawnTimer = 0;
            jewellerySpawnTimer = 0;
            obstacles = [];
            coinsList = [];
            jewelleryList = [];
            jumpingPressed = false;
            jumpingPressedPrev = false;
            document.getElementById('game-over').style.display = 'none';
            bgMusic.currentTime = 0;
            tryStartMusic();
            drawScore();
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            animationId = requestAnimationFrame(gameLoop);
        }
        function restartGame() {
            showCharSelect();
        }
        function openShop() {
            document.getElementById('char-select').style.display = 'none';
            document.getElementById('shop').style.display = 'flex';
            document.getElementById('shop-coins').textContent = coins;
            if (kittenReady) {
                document.getElementById('kitten-preview').src = kittenSrc;
            }
            if (coinReady) {
                document.getElementById('coin-icon').src = coinSrc;
            }
            if (puppyReady) {
                document.getElementById('puppy-preview').src = puppySrc;
            }
            if (coinReady) {
                document.getElementById('coin-icon2').src = coinSrc;
            }
            if (crownReady) {
                document.getElementById('crown-preview').src = crownSrc;
            }
            if (coinReady) {
                document.getElementById('coin-icon3').src = coinSrc;
            }
        }
        function closeShop() {
            document.getElementById('shop').style.display = 'none';
            document.getElementById('char-select').style.display = 'flex';
        }
        function buyKitten() {
            if (coins >= 50 && !inventory.includes('kitten')) {
                coins -= 50;
                inventory.push('kitten');
                localStorage.setItem('coins', coins);
                localStorage.setItem('inventory', JSON.stringify(inventory));
                document.getElementById('shop-coins').textContent = coins;
                alert("Yay! You got the Fluffy Kitten! üòª");
            } else if (inventory.includes('kitten')) {
                alert("You already have the Fluffy Kitten! üê±");
            } else {
                alert("Oops, you need 50 coins! Keep collecting! üí∞");
            }
        }
        function buyPuppy() {
            if (coins >= 50 && !inventory.includes('puppy')) {
                coins -= 50;
                inventory.push('puppy');
                localStorage.setItem('coins', coins);
                localStorage.setItem('inventory', JSON.stringify(inventory));
                document.getElementById('shop-coins').textContent = coins;
                alert("Yay! You got the Cute Puppy! üê∂");
            } else if (inventory.includes('puppy')) {
                alert("You already have the Cute Puppy! üêï");
            } else {
                alert("Oops, you need 50 coins! Keep collecting! üí∞");
            }
        }
        function buyCrown() {
            if (coins >= 50 && !inventory.includes('crown')) {
                coins -= 50;
                inventory.push('crown');
                localStorage.setItem('coins', coins);
                localStorage.setItem('inventory', JSON.stringify(inventory));
                document.getElementById('shop-coins').textContent = coins;
                alert("Yay! You got the Princess Crown! üëë");
            } else if (inventory.includes('crown')) {
                alert("You already have the Princess Crown! üëë");
            } else {
                alert("Oops, you need 50 coins! Keep collecting! üí∞");
            }
        }
        function openMyStuff() {
            document.getElementById('char-select').style.display = 'none';
            document.getElementById('my-stuff').style.display = 'flex';
            const list = document.getElementById('inventory-list');
            list.innerHTML = '';
            if (inventory.includes('kitten')) {
                let buttonHtml = '';
                if (equippedPet === 'kitten') {
                    buttonHtml = '<button onclick="removeKitten()">Remove</button>';
                } else {
                    buttonHtml = '<button onclick="useKitten()">Use this item</button>';
                }
                list.innerHTML += '<div><h3>Fluffy Kitten</h3><img src="' + kittenSrc + '" alt="Fluffy Kitten" style="width: 100px; height: 100px; border-radius: 10px;">' + buttonHtml + '</div>';
            }
            if (inventory.includes('puppy')) {
                let buttonHtml = '';
                if (equippedPet === 'puppy') {
                    buttonHtml = '<button onclick="removePuppy()">Remove</button>';
                } else {
                    buttonHtml = '<button onclick="usePuppy()">Use this item</button>';
                }
                list.innerHTML += '<div><h3>Cute Puppy</h3><img src="' + puppySrc + '" alt="Cute Puppy" style="width: 100px; height: 100px; border-radius: 10px;">' + buttonHtml + '</div>';
            }
            if (inventory.includes('crown')) {
                let buttonHtml = '';
                if (equippedAccessory === 'crown') {
                    buttonHtml = '<button onclick="removeCrown()">Remove</button>';
                } else {
                    buttonHtml = '<button onclick="useCrown()">Use this item</button>';
                }
                list.innerHTML += '<div><h3>Princess Crown</h3><img src="' + crownSrc + '" alt="Princess Crown" style="width: 100px; height: 100px; border-radius: 10px;">' + buttonHtml + '</div>';
            }
            if (inventory.length === 0) {
                list.innerHTML += '<p>You don\'t have any stuff yet! Go shopping! üõçÔ∏è</p>';
            }
        }
        function useKitten() {
            equippedPet = 'kitten';
            localStorage.setItem('equippedPet', equippedPet);
            alert("Fluffy Kitten is now with you! üòª");
            openMyStuff(); // Refresh the list to show the remove button
        }
        function usePuppy() {
            equippedPet = 'puppy';
            localStorage.setItem('equippedPet', equippedPet);
            alert("Cute Puppy is now with you! üê∂");
            openMyStuff(); // Refresh the list to show the remove button
        }
        function removeKitten() {
            equippedPet = null;
            localStorage.removeItem('equippedPet');
            alert("Fluffy Kitten has been removed! üê±");
            openMyStuff(); // Refresh the list to show the use button
        }
        function removePuppy() {
            equippedPet = null;
            localStorage.removeItem('equippedPet');
            alert("Cute Puppy has been removed! üêï");
            openMyStuff(); // Refresh the list to show the use button
        }
        function useCrown() {
            equippedAccessory = 'crown';
            localStorage.setItem('equippedAccessory', equippedAccessory);
            alert("Princess Crown is now equipped! üëë");
            openMyStuff(); // Refresh the list to show the remove button
        }
        function removeCrown() {
            equippedAccessory = null;
            localStorage.removeItem('equippedAccessory');
            alert("Princess Crown has been removed! üëë");
            openMyStuff(); // Refresh the list to show the use button
        }
        function closeMyStuff() {
            document.getElementById('my-stuff').style.display = 'none';
            document.getElementById('char-select').style.display = 'flex';
        }
        function openMyHouse() {
            document.getElementById('char-select').style.display = 'none';
            document.getElementById('my-house').style.display = 'flex';
        }
        function closeMyHouse() {
            document.getElementById('my-house').style.display = 'none';
            document.getElementById('char-select').style.display = 'flex';
        }
        // Add event listeners to save data before unloading
        window.addEventListener('beforeunload', () => {
            localStorage.setItem('coins', coins);
            localStorage.setItem('jewellery', jewellery);
            localStorage.setItem('inventory', JSON.stringify(inventory));
            if (equippedPet) localStorage.setItem('equippedPet', equippedPet);
            if (equippedAccessory) localStorage.setItem('equippedAccessory', equippedAccessory);
        });
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            waterHeight = canvas.height * waterHeightRatio;
            if (selectedIndex !== -1) resetCharacters();
        });
        characters.forEach((char, index) => {
            char.image.addEventListener('load', () => {
                processImage(char.image, index, (processedImg) => {
                    char.image = processedImg;
                    char.ready = true;
                }, false);
            });
            char.image.addEventListener('error', () => {
                console.warn(`Error loading ${char.name}'s image - check file path!`);
            });
            if (char.image.complete && char.image.naturalWidth) {
                char.image.dispatchEvent(new Event('load'));
            }
        });
        // Process the jewellery image with auto background removal
        jewelleryImage.addEventListener('load', () => {
            processImage(jewelleryImage, -1, (processedImg) => {
                jewellerySrc = processedImg.src;
                jewelleryImage = processedImg;
                jewelleryReady = true;
                document.getElementById('jewellery-display-img').src = jewellerySrc;
            }, true);
        });
        jewelleryImage.addEventListener('error', () => {
            console.warn('Error loading jewellery image - check file path!');
        });
        if (jewelleryImage.complete && jewelleryImage.naturalWidth) {
            jewelleryImage.dispatchEvent(new Event('load'));
        }
        // Process the coin image with auto background removal
        coinImage.addEventListener('load', () => {
            processImage(coinImage, -1, (processedImg) => {
                coinSrc = processedImg.src;
                coinImage = processedImg;
                coinReady = true;
                document.getElementById('coin-display-img').src = coinSrc;
                if (document.getElementById('coin-icon')) {
                    document.getElementById('coin-icon').src = coinSrc;
                }
                if (document.getElementById('coin-icon2')) {
                    document.getElementById('coin-icon2').src = coinSrc;
                }
                if (document.getElementById('coin-icon3')) {
                    document.getElementById('coin-icon3').src = coinSrc;
                }
            }, true);
        });
        coinImage.addEventListener('error', () => {
            console.warn('Error loading coin image - check file path!');
        });
        if (coinImage.complete && coinImage.naturalWidth) {
            coinImage.dispatchEvent(new Event('load'));
        }
        // Process the kitten image with auto background removal
        kittenImage.addEventListener('load', () => {
            processImage(kittenImage, -1, (processedImg) => {
                kittenSrc = processedImg.src;
                kittenImage = processedImg;
                kittenReady = true;
                if (document.getElementById('kitten-preview')) {
                    document.getElementById('kitten-preview').src = kittenSrc;
                }
            }, true);
        });
        kittenImage.addEventListener('error', () => {
            console.warn('Error loading kitten image - check file path!');
        });
        if (kittenImage.complete && kittenImage.naturalWidth) {
            kittenImage.dispatchEvent(new Event('load'));
        }
        // Process the puppy image with auto background removal
        puppyImage.addEventListener('load', () => {
            processImage(puppyImage, -1, (processedImg) => {
                puppySrc = processedImg.src;
                puppyImage = processedImg;
                puppyReady = true;
                if (document.getElementById('puppy-preview')) {
                    document.getElementById('puppy-preview').src = puppySrc;
                }
            }, true);
        });
        puppyImage.addEventListener('error', () => {
            console.warn('Error loading puppy image - check file path!');
        });
        if (puppyImage.complete && puppyImage.naturalWidth) {
            puppyImage.dispatchEvent(new Event('load'));
        }
        // Process the crown image with auto background removal
        crownImage.addEventListener('load', () => {
            processImage(crownImage, -1, (processedImg) => {
                crownSrc = processedImg.src;
                crownImage = processedImg;
                crownReady = true;
                if (document.getElementById('crown-preview')) {
                    document.getElementById('crown-preview').src = crownSrc;
                }
            }, true);
        });
        crownImage.addEventListener('error', () => {
            console.warn('Error loading crown image - check file path!');
        });
        if (crownImage.complete && crownImage.naturalWidth) {
            crownImage.dispatchEvent(new Event('load'));
        }
        // Initial display updates
        document.getElementById('coin-count').textContent = coins;
        document.getElementById('jewellery-count').textContent = jewellery;
        showCharSelect();
    </script>
</body>
</html>
